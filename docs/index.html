
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>SCALP — Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  :root {
    --bg:#0b0f14; --card:#121820; --text:#e6edf3; --muted:#9aa6b2;
    --ok:#2aa745; --dat:#c89d28; --old:#d0443e; --mis:#7b8a97; --chip:#1f2937;
    --accent:#3b82f6; --border:#223040;
  }
  html,body { background:var(--bg); color:var(--text); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:0; }
  .wrap { max-width:1100px; margin:0 auto; padding:20px; }
  h1 { font-size:2.1rem; margin:10px 0 8px; }
  small.muted { color:var(--muted); }
  .row { display:grid; grid-template-columns: 1fr; gap:16px; }
  @media (min-width: 900px) {
    .row-2 { grid-template-columns: 1fr 1fr; }
  }
  .card { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:18px; }
  .title { font-size:1.25rem; margin:0 0 10px; }
  .chips span { display:inline-block; background:var(--chip); padding:6px 10px; border-radius:999px; margin-right:8px; font-weight:600; }
  .chips .mis { background:var(--mis); color:#081217; }
  .chips .old { background:var(--old); color:#fff; }
  .chips .dat { background:var(--dat); color:#0b0f14; }
  .chips .ok  { background:var(--ok);  color:#0b0f14; }
  .muted { color:var(--muted); }
  .flex { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  button.refresh { background:var(--accent); color:white; border:0; padding:6px 12px; border-radius:8px; cursor:pointer; }
  table { width:100%; border-collapse:collapse; }
  th,td { padding:8px 10px; border-bottom:1px solid var(--border); }
  th { text-align:left; color:var(--muted); font-weight:600; }
  tr:hover td { background:#0f141c; }
  .right { text-align:right; }
  .placeholder { border:1px dashed var(--border); color:var(--muted); padding:18px; border-radius:10px; }
  .badge { padding:3px 8px; border-radius:6px; font-weight:700; }
  .badge.ok  { background:var(--ok);  color:#0b0f14; }
  .badge.dat { background:var(--dat); color:#0b0f14; }
  .badge.old { background:var(--old); color:#fff;    }
  .badge.mis { background:var(--mis); color:#081217;}
</style>
</head>
<body>
<div class="wrap">
  <h1>SCALP — Dashboard <small class="muted">(2025-08-28 13:52:59 UTC)</small></h1>
  <div class="flex" style="margin:6px 0 18px;">
    <div class="muted">Auto-refresh: <b id="rf-interval">5s</b> · reload dans <span id="rf-count">5</span>s</div>
    <button class="refresh" onclick="location.reload()">Refresh</button>
  </div>

  <div class="row row-2">
    <div class="card">
      <div class="title">Health</div>
      <div id="health">
        <div><span class="muted">generated_at:</span> <b>1756387175</b></div>
        <div><span class="muted">commit:</span> <b>20938db</b></div>
        <div><span class="muted">status:</span> <b style="color:var(--ok);">ok</b></div>
      </div>
    </div>

    <div class="card">
      <div class="title">Compteurs</div>
      <div class="chips">
        <span class="mis">MIS: 0</span>
        <span class="old">OLD: 0</span>
        <span class="dat">DAT: 0</span>
        <span class="ok">OK: 0</span>
      </div>
      <div class="muted" style="margin-top:8px;">
        MIS: no data · OLD: stale · DAT: fresh CSV, no active strategy · OK: fresh CSV + active strategy
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="title">Heatmap (pair × TF)</div>
    <div id="heat" class="placeholder">Matrice en préparation… en attente des premiers résultats/metrics.</div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="title">TOP résultats</div>
    <div class="flex" style="margin-bottom:10px;">
      <label>Pair :
        <select id="f_pair">
          <option value="">(toutes)</option>
          
        </select>
      </label>
      <label>TF :
        <select id="f_tf">
          <option value="">(tous)</option>
          
        </select>
      </label>
    </div>
    <div id="top_table"></div>
  </div>

  <div class="muted" style="margin:20px 0 6px;">
    <small>Dernier backtest: <b>—</b> (age: n/a) · risk_mode: <b>n/a</b></small>
  </div>
</div>

<script>
  // ---- Auto-refresh 5s
  let left = 5;
  const span = document.getElementById('rf-count');
  setInterval(() => {
    left = Math.max(0, left-1);
    if (span) span.textContent = left;
    if (left === 0) location.reload();
  }, 1000);

  // ---- Données injectées (côté client) pour filtres/plot
  const HEAT = {};
  const PAIRS = [];
  const TFS = [];
  const TOP_ROWS = [];

  // ---- Heatmap Plotly
  function renderHeat() {
    const el = document.getElementById('heat');
    if (!el) return;
    const pairs = PAIRS;
    const tfs = TFS;
    if (!pairs.length || !tfs.length) {
      el.className = 'placeholder';
      el.innerText = 'Aucune matrice exploitable (pas encore de PF par pair×TF).';
      return;
    }
    const z = [];
    for (let i=0;i<pairs.length;i++) {
      const row = [];
      for (let j=0;j<tfs.length;j++) {
        const p = pairs[i];
        const tf = tfs[j];
        const v = (HEAT[p] && HEAT[p][tf] != null) ? HEAT[p][tf] : null;
        row.push(v);
      }
      z.push(row);
    }
    el.className = '';
    el.innerHTML = '';
    const data = [{
      z: z, x: tfs, y: pairs, type:'heatmap', colorscale:'Viridis', hoverongaps:false,
      colorbar: {title:'PF', outlinewidth:0}
    }];
    const layout = {
      paper_bgcolor:'#121820', plot_bgcolor:'#121820',
      font:{color:'#e6edf3'},
      margin:{l:80,r:10,t:10,b:40}
    };
    Plotly.newPlot(el, data, layout, {responsive:true, displayModeBar:false});
  }

  // ---- TOP table + filtres
  function number(x, d=2) {
    if (x===null||x===undefined||isNaN(x)) return '–';
    return Number(x).toFixed(d);
  }
  function badge(state) {
    const cls = state || '';
    const val = (state||'').toUpperCase() || '—';
    cls = locals().get("cls", "bg-secondary"); cls = locals().get("cls", "bg-secondary"); return f'<span class="badge bg-secondary"></span>';
  }
  function renderTop() {
    const selPair = document.getElementById('f_pair').value;
    const selTf = document.getElementById('f_tf').value;
    let rows = TOP_ROWS.slice();
    if (selPair) rows = rows.filter(r => (r.pair===selPair)||(r.symbol===selPair)||(r.pair_tf||'').startsWith(selPair+':'));
    if (selTf)   rows = rows.filter(r => (r.tf===selTf)||(r.pair_tf||'').endsWith(':'+selTf));
    const head = `
      <table>
        <thead><tr>
          <th>Pair</th><th>TF</th><th>PF</th><th>WR</th><th>MDD</th><th>Trades</th><th>Name</th>
        </tr></thead><tbody>`;
    const body = rows.map(r => {
      const m = r.metrics||{};
      const pair = r.pair || (r.pair_tf||'').split(':')[0] || r.symbol || '—';
      const tf   = r.tf   || (r.pair_tf||'').split(':')[1] || '—';
      return `<tr>
        <td>${pair}</td>
        <td>${tf}</td>
        <td class="right">${number(m.pf,2)}</td>
        <td class="right">${number(m.wr,2)}</td>
        <td class="right">${number(m.mdd,2)}</td>
        <td class="right">${m.trades??'–'}</td>
        <td>${r.name||'—'}</td>
      </tr>`;
    }).join('');
    const tail = `</tbody></table>`;
    document.getElementById('top_table').innerHTML = head + (body || `<div class="placeholder">Aucun résultat pour ce filtre.</div>`) + tail;
  }

  document.getElementById('f_pair').addEventListener('change', renderTop);
  document.getElementById('f_tf').addEventListener('change', renderTop);

  renderHeat();
  renderTop();
</script>
</body>
</html>
